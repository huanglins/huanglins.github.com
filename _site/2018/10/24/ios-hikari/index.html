<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="// iOS Developer，也写Android和Python。正在学习全栈。很高兴认识你。">
    <meta name="keywords"  content="vincent，vincents，黄霖，黄金霖，darnel，darnel studio，个人网站，APP，微信公众号">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="iOS 马甲包、代码混淆、编译混淆实践 - Vincent's Blog | 永远年轻，永远热泪盈眶">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="1. 马甲包
1.1 什么是马甲包?
马甲包是利用 App store 的规则漏洞，通过技术手段，多次上架同一款产品的方法。马甲包和主产品包拥有基本一致的内容和功能，项目代码基本都是完全复用的，除了图标，应用名称，包名等不一致，其他基本一致。

">
    
    <meta property="article:published_time" content="2018-10-24T00:00:00Z">
    
    
    <meta property="article:author" content="vincent">
    
    
    <meta property="article:tag" content="iOS">
    
    <meta property="article:tag" content="逆向工程">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar-sea-vincent.jpg">
    <meta property="og:url" content="http://localhost:4000/2018/10/24/ios-hikari/">
    <meta property="og:site_name" content="Vincent's Blog | 永远年轻，永远热泪盈眶">
    
    <title>iOS 马甲包、代码混淆、编译混淆实践 - Vincent's Blog | 永远年轻，永远热泪盈眶</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2018/10/24/ios-hikari/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">tnecniV</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/archive/">标签</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- <img src="/img/post-bg-17-hikari.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-17-hikari.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=iOS" title="iOS">iOS</a>
                        
                        <a class="tag" href="/archive/?tag=%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B" title="逆向工程">逆向工程</a>
                        
                    </div>
                    <h1>iOS 马甲包、代码混淆、编译混淆实践</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by vincent on October 24, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h2 id="1-马甲包">1. 马甲包</h2>
<h3 id="11-什么是马甲包">1.1 什么是马甲包?</h3>
<p>马甲包是利用 App store 的规则漏洞，通过技术手段，多次上架同一款产品的方法。马甲包和主产品包拥有基本一致的内容和功能，项目代码基本都是完全复用的，除了图标，应用名称，包名等不一致，其他基本一致。</p>

<h3 id="12-为什么做马甲包以及马甲包的好处">1.2 为什么做马甲包，以及马甲包的好处</h3>

<ul>
  <li>
    <p><strong>AB 测试</strong>
  可以测试跨度大的新功能，好的功能就在主包上迭代，不好的也无所谓，不影响主包的使用体验，避免用户流失。</p>
  </li>
  <li>
    <p><strong>导流</strong>
  主包和马甲包同属一个平台，用户信息可以共享；通过弹窗,广告,Push等引导用户到App Store下载主App；有一部份App接了网盟相互导流。</p>
  </li>
  <li>
    <p><strong>增加关键词覆盖</strong>
  App Store关键词长度上限是100个字符,据了解人为正常优化的极限是关键词覆盖数在4000左右,那些覆盖数在8000+的都是利用了苹果漏洞。所以,多做一个马甲,也就意味着覆盖的关键词可以更多。</p>
  </li>
  <li>
    <p><strong>刷榜</strong>
  积分墙、真机、机刷等。用马甲包来刷排名，抵抗主包风险。</p>
  </li>
</ul>

<h3 id="13-马甲包制作注意事项">1.3 马甲包制作注意事项</h3>

<ul>
  <li>
    <p><strong>二进制不同</strong>
  应用名称，图标，包名，工程名，打包电脑，代码，静态资源等的修改。</p>
  </li>
  <li>
    <p><strong>差异化</strong>
  整体UI，产品功能，页面布局等的修改</p>
  </li>
</ul>

<h3 id="14-实践">1.4 实践</h3>
<p><a href="https://github.com/klaus01/KLGenerateSpamCode">KLGenerateSpamCode</a> 是一个应对苹果对重复应用的审核（Guideline 4.3 Design Spam）的工具，用于避免苹果机审检测概率。</p>

<p>主要功能有：</p>

<ul>
  <li>修改工程名</li>
  <li>修改类名前缀</li>
  <li>扫描工程中的代码，生成同等数量的 Category 文件，文件中及是同等方法数量的垃圾代码。</li>
  <li>修改 xxx.xcassets 文件夹中的 png 资源文件名。</li>
  <li>删除代码中的所有注释和空行。</li>
</ul>

<p><img src="/img/p-ios-hikari/15402030163246.jpg" alt="-w910" /></p>

<p>示例：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre># 1. 项目名地址，注意不是项目文件夹地址
/Users/vincent/Desktop/code/spamCode/VHLSpamCodeDemo/VHLSpamCodeDemo   
# 2. 修改项目名称
-modifyProjectName VHLSpamCodeDemo&gt;VHLSpamCodeDemo1
# 3. 忽略文件夹
-ignoreDirNames Depends
# 4. 修改类名前缀。没有前缀的会加上前缀，有前缀的会修改。注意修改后是否重名
-modifyClassNamePrefix /Users/vincent/Desktop/code/spamCode/VHLSpamCodeDemo/VHLSpamCodeDemo.xcodeproj VHL&gt;VIN
# 5. 生成垃圾代码
-spamCodeOut /Users/vincent/Desktop/code/spamCode/VHLSpamCodeDemo/VHLSpamCodeDemo2/SpamCode VSpam
# 6. 修改 xxx.xcassets 文件夹中的 png 资源文件名
-handleXcassets
# 7. 删除空行和注释 
-deleteComments
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/img/p-ios-hikari/15402873574819.jpg" alt="-w1075" /></p>

<p>修改工程名后，如果包含 pod，需要到文件夹下重新执行 <code class="highlighter-rouge">pod update</code></p>

<h3 id="15-优化图片大小修改图片-hash-值">1.5 优化图片大小，修改图片 hash 值</h3>

<ul>
  <li>
    <p><a href="https://imageoptim.com/mac">ImageOptim</a></p>

    <p>mac 下无损压缩图片工具，将包含图片的文件夹拖入工具，会自动扫描文件夹下的所有文件，自动选择最优算法进行优化。一般第一次优化项目时，会有几M到10几M的优化效果。</p>
  </li>
  <li>
    <p><a href="http://www.imagemagick.org/script/index.php">ImageMagick</a></p>

    <p>ImageMagick: 是一款创建、编辑、合成，转换图像的命令行工具。</p>

    <p>通过 <code class="highlighter-rouge">brew</code> 安装 <code class="highlighter-rouge">imagemagick</code></p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  brew install imagemagick
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>压缩文件夹下所有 png 文件，会修改 hash 值</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  find . -iname "*.png" -exec echo {} \; -exec convert {} {} \;
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>更多 <code class="highlighter-rouge">imagemagick</code> 命令以及使用方法 
  <a href="https://aotu.io/notes/2018/06/06/ImageMagick_intro/index.html">图像处理 - ImageMagick 简单介绍与案例</a></p>
  </li>
</ul>

<h2 id="2-逆向基础以及为什么要做混淆">2. 逆向基础，以及为什么要做混淆</h2>

<p>当我们用 Xcode 构建一个程序的过程时，编译器会把源文件 (.m 和 .h) 文件转换为一个可执行文件。这个可执行文件中包含的字节码会将被 CPU 执行，虽然不能直接从这些字节码中查看我们的核心代码，但是黑客可以通过一些反汇编的逆向工具来分析我们的程序，找到漏洞进行破解。</p>

<blockquote>
  <p>可执行文件格式</p>
</blockquote>

<p><strong>EXE</strong>     <code class="highlighter-rouge">Windows</code> 下可直接执行的文件扩展名
<strong>ELF</strong>     <code class="highlighter-rouge">Linux</code> 下的可执行文件
<strong>Mach-O</strong>  <code class="highlighter-rouge">MacOS/iOS</code> 下主要的可执行文件</p>

<h3 id="21-mach-与-mach-o">2.1 Mach 与 Mach-O</h3>

<p>Mac 是苹果电脑 Macintosh 的简称，而 Mach 则是一种操作系统内核。Mach 内核被 NeXT 公司的NeXTSTEP 操作系统使用。在Mach上，一种可执行的文件格是就是 Mach-O（Mach Object file format）。1996年，乔布斯将 NeXTSTEP 带回苹果，成为了OS X的内核基础。所以虽然 MacOS X 是 Unix 的“后代”，但所主要支持的可执行文件格式是 Mach-O。</p>

<h3 id="22-ios-可执行文件">2.2 iOS 可执行文件</h3>

<p>通常我们通过 Xcode 打包或者从应用商店下载的 APP 都是 <code class="highlighter-rouge">ipa</code> 包（iPhone Application）。这是一个变相的 zip 压缩包，可以通过 <code class="highlighter-rouge">unzip</code> 命令进行解压。</p>

<p>解压之后，会有一个 Payload 目录，而 Payload 里则是一个 <strong>.app</strong> 文件，而这个实际上又是一个目录，或者说是一个完整的 App Bundle。</p>

<p>在这个目录中，里面体积最大的文件通常就是和 ipa 包同名的一个二进制文件。通过 <code class="highlighter-rouge">file</code> 命令可以查看该文件的类型</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>xx: Mach-O universal binary with 2 architectures: [arm_v7:Mach-O executable arm_v7] [arm64]
xx (for architecture armv7):	Mach-O executable arm_v7
xx (for architecture arm64):	Mach-O 64-bit executable arm64
</pre></td></tr></tbody></table></code></pre></div></div>
<p>这里可以看出，这是一个支持 armv7 和 armv7s 两种处理器架构的通用程序包，里面包含的两部分都是 Mach-O 格式。</p>

<blockquote>

  <p><strong>i386</strong> 模拟器32位处理器
<strong>x86_64</strong> 模拟器64位处理器
<strong>armv7,armv7s</strong> 真机32位处理器
<strong>arm64</strong> 真机64位处理器</p>
</blockquote>

<p>Mach-O 的文件结构：</p>

<p><img src="/img/p-ios-hikari/15402721412482.gif" alt="" /></p>

<p>从这张图上来看，Mach-O文件的数据主体可分为三大部分，分别是头部（Header）、加载命令（Load commands）、和最终的数据（Data）。</p>

<h3 id="23-class-dump">2.3 class-dump</h3>

<p><a href="http://stevenygard.com/projects/class-dump/">class-dump</a> 是一个利用 Objective-C 语言的 runtime 特性，将存储在 Mach-O 文件结构里 data 部分的类属性和方法等信息提取出来，并生成对应的 .h 文件的工具。<strong>注意: 必须是脱壳后的可执行文件。(比如通过越狱手机或者第三方应用下载渠道)</strong></p>

<h4 id="24-安装使用">2.4 安装使用</h4>

<p>在 <a href="http://stevenygard.com/projects/class-dump/">class-dump</a> 官网下载 dmg，将 dmg 里面的 <code class="highlighter-rouge">class-dump</code> 拷贝到 <code class="highlighter-rouge">/usr/local/bin</code> 文件夹下，然后就可以在终端中使用 <code class="highlighter-rouge">class-dump</code> 命令了。</p>

<p>简单使用：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>class-dump -H [需要被导出的 Mach-O 文件路径] -o [头文件输出目录地址]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>也可以可以查看导出后的头文件目录：</p>

<p><img src="/img/p-ios-hikari/15402749967715.jpg" alt="-w621" /></p>

<h3 id="25-hopper">2.5 hopper</h3>

<p><a href="https://www.hopperapp.com/">Hopper</a> 是一种适用于 OS X 和 Linux 的逆向工程工具，可以用于反汇编、反编译和调试 32位/64位英特尔处理器的 Mac、Linux、Windows 和 iOS 可执行程序。</p>

<p>将 Mach-O 文件拖入 <a href="https://www.hopperapp.com">hopper</a> 可以查看。</p>

<p><img src="/img/p-ios-hikari/15402820640765.jpg" alt="-w1425" /></p>

<p>通过以上的方式，别人可以对照应用的功能来分析代码逻辑，从而进行针对性的破解。所以对项目的核心的代码进行混淆就是非常有必要的了。</p>

<h2 id="3-代码混淆">3. 代码混淆</h2>

<p>常规的混淆思路：</p>

<ul>
  <li>花代码花指令，即随意往程序中加入迷惑人的代码指令</li>
  <li>易读字符替换</li>
</ul>

<p>防止被 class-dump 后，被人分析核心代码逻辑。可以对关键，已读的字符串进行替换，比如 <code class="highlighter-rouge">ad</code>, <code class="highlighter-rouge">vip</code> 等关键词。</p>

<h3 id="31-替换字符串混淆">3.1 替换字符串混淆</h3>

<p>但是我们又不想替换成不想关的字符串后给自己调试带来麻烦，这里我们可以使用 <a href="https://github.com/housenkui/HSKConfuse">HSKConfuse</a> 的 shell 脚本，通过在Build Phrase 中设定在编译之前进行方法名的字符串替换，从而在不影响自己编写代码的基础上，对编译后的二进制包进行混淆。</p>

<p>首先在项目中新建文件：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>confuse.sh： 存放混淆的脚本
func.list： 需要混淆的方法、变量名
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>confuse.sh</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre><span class="c">#!/usr/bin/env bash</span>

<span class="nv">TABLENAME</span><span class="o">=</span>symbols
<span class="nv">SYMBOL_DB_FILE</span><span class="o">=</span><span class="s2">"symbols"</span>
<span class="nv">STRING_SYMBOL_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PROJECT_DIR</span><span class="s2">/VHLObfuscationDemo/VHLObfuscation/func.list"</span>

<span class="nv">CONFUSE_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PROJECT_DIR</span><span class="s2">/VHLObfuscationDemo"</span>
<span class="nv">HEAD_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PROJECT_DIR</span><span class="s2">/VHLObfuscationDemo/VHLObfuscation/codeObfuscation.h"</span>

<span class="nb">export </span><span class="nv">LC_CTYPE</span><span class="o">=</span>C

<span class="c"># ** 可以不执行下面的方法，替换成自己的规则手动写入到 func.list 中**</span>
<span class="c"># 取以.m或.h结尾的文件以+号或-号开头的行，并以 vhl_ 开头的方法 |去掉所有+号或－号|用空格代替符号|n个空格跟着&lt;号 替换成 &lt;号|开头不能是IBAction|用空格split字串取第二部分|排序|去重复|删除空行|删掉以init开头的行&gt;写进func.list</span>
<span class="nb">grep</span> <span class="nt">-h</span> <span class="nt">-r</span> <span class="nt">-I</span>  <span class="s2">"^[-+]"</span> <span class="nv">$CONFUSE_FILE</span>  <span class="nt">--include</span> <span class="s1">'*.[mh]'</span> |sed <span class="s2">"s/[+-]//g"</span>|sed <span class="s2">"s/[();,: *</span><span class="se">\^\/\{</span><span class="s2">]/ /g"</span>|sed <span class="s2">"s/[ ]*&lt;/&lt;/"</span>| <span class="nb">sed</span> <span class="s2">"/^[ ]*IBAction/d"</span>|awk <span class="s1">'{split($0,b," "); print b[2]; }'</span>| <span class="nb">sort</span>|uniq |sed <span class="s2">"/^</span><span class="nv">$/</span><span class="s2">d"</span>|sed <span class="nt">-n</span> <span class="s2">"/^vhl_/p"</span> <span class="o">&gt;</span><span class="nv">$STRING_SYMBOL_FILE</span>

<span class="c">#维护数据库方便日后作排重,以下代码来自念茜的微博</span>
createTable<span class="o">()</span>
<span class="o">{</span>
<span class="nb">echo</span> <span class="s2">"create table </span><span class="nv">$TABLENAME</span><span class="s2">(src text, des text);"</span> | sqlite3 <span class="nv">$SYMBOL_DB_FILE</span>
<span class="o">}</span>

insertValue<span class="o">()</span>
<span class="o">{</span>
<span class="nb">echo</span> <span class="s2">"insert into </span><span class="nv">$TABLENAME</span><span class="s2"> values('</span><span class="nv">$1</span><span class="s2">' ,'</span><span class="nv">$2</span><span class="s2">');"</span> | sqlite3 <span class="nv">$SYMBOL_DB_FILE</span>
<span class="o">}</span>

query<span class="o">()</span>
<span class="o">{</span>
<span class="nb">echo</span> <span class="s2">"select * from </span><span class="nv">$TABLENAME</span><span class="s2"> where src='</span><span class="nv">$1</span><span class="s2">';"</span> | sqlite3 <span class="nv">$SYMBOL_DB_FILE</span>
<span class="o">}</span>

ramdomString<span class="o">()</span>
<span class="o">{</span>
openssl rand <span class="nt">-base64</span> 64 | <span class="nb">tr</span> <span class="nt">-cd</span> <span class="s1">'a-zA-Z'</span> |head <span class="nt">-c</span> 16

<span class="o">}</span>

<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$SYMBOL_DB_FILE</span>
<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$HEAD_FILE</span>
createTable

<span class="nb">touch</span> <span class="nv">$HEAD_FILE</span>
<span class="nb">echo</span> <span class="s1">'#ifndef Demo_codeObfuscation_h
#define Demo_codeObfuscation_h'</span> <span class="o">&gt;&gt;</span> <span class="nv">$HEAD_FILE</span>
<span class="nb">echo</span> <span class="s2">"//confuse string at </span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$HEAD_FILE</span>
<span class="nb">cat</span> <span class="s2">"</span><span class="nv">$STRING_SYMBOL_FILE</span><span class="s2">"</span> | <span class="k">while </span><span class="nb">read</span> <span class="nt">-ra</span> line<span class="p">;</span> <span class="k">do
if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$line</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
</span><span class="nv">ramdom</span><span class="o">=</span><span class="sb">`</span>ramdomString<span class="sb">`</span>
<span class="nb">echo</span> <span class="nv">$line</span> <span class="nv">$ramdom</span>
insertValue <span class="nv">$line</span> <span class="nv">$ramdom</span>
<span class="nb">echo</span> <span class="s2">"#define </span><span class="nv">$line</span><span class="s2"> </span><span class="nv">$ramdom</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$HEAD_FILE</span>
<span class="k">fi
done
</span><span class="nb">echo</span> <span class="s2">"#endif"</span> <span class="o">&gt;&gt;</span> <span class="nv">$HEAD_FILE</span>

sqlite3 <span class="nv">$SYMBOL_DB_FILE</span> .dump

</pre></td></tr></tbody></table></code></pre></div></div>

<p>以上的 shell 脚本运行后会自动获取 <code class="highlighter-rouge">.h</code>, <code class="highlighter-rouge">m</code> 文件中以 <code class="highlighter-rouge">vhl_</code> 开头的方法写到到该文件。如果需要自定义的话，可以不执行以上那句命令，然后换成自己的规则写入 <strong>func.list</strong> 中。例如：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>vhl_isVIP
xx_showAD
yy_isAllow
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后在 <code class="highlighter-rouge">Build Phases</code> 中，左上角加号添加 <code class="highlighter-rouge">run script</code> 填入地址</p>

<p><img src="/img/p-ios-hikari/15402815261872.jpg" alt="-w1125" /></p>

<h3 id="32-查看编译结果">3.2 查看编译结果</h3>

<p><img src="/img/p-ios-hikari/15403674704990.jpg" alt="-w899" />
成功编译后，会在指定目录下生成一个 <code class="highlighter-rouge">codeObfuscation.h</code> 文件。这里可以看到，在编译过程中会执行 shell 脚本，对相关字符串进行替换</p>

<p>添加 <code class="highlighter-rouge">.pch</code> 文件，并在 <code class="highlighter-rouge">Build Setttings</code> &gt; <code class="highlighter-rouge">Prefix Header</code> 中链接该 <code class="highlighter-rouge">.pch</code> 文件，在 <code class="highlighter-rouge">.pch</code> 文件中导入 <code class="highlighter-rouge">codeObfuscation.h</code>，此时项目中指定的方法都被替换成了<code class="highlighter-rouge">codeObfuscation.h</code> 中的宏定义。</p>

<p><img src="/img/p-ios-hikari/15402867506913.jpg" alt="-w906" /></p>

<p>运行成功后将 Products 中的二进制文件拖入到 hopper 中查看</p>

<p><img src="/img/p-ios-hikari/15402864436528.jpg" alt="-w1008" /></p>

<p>此时，方法已经被混淆了。</p>

<p><strong>注意：这个不要大面积的使用，会有被审核拒绝的风险，拒绝原因是说你程序里面可能包含有隐藏功能，因为 apple 无法从这些混淆后的方法获取到有用的信息。</strong></p>

<h2 id="4-编译混淆">4. 编译混淆</h2>

<p>以上我们虽然对关键字符串进行了混淆，但是实际代码的执行逻辑等并没有改变。黑客仍然可以通过分析代码逻辑或者伪代码来寻找程序的漏洞。那有没有可能改变编译后的代码逻辑，从而让别人无法分析我们的程序呢。</p>

<h3 id="41-ios-是如何编译的">4.1 iOS 是如何编译的</h3>
<p>Objective C采用 <strong>Clang</strong> 作为前端，而 Swift 则采用 <strong>swift()</strong> 作为前端，二者都是用 <strong>LLVM(Low level vritual machine)</strong> 作为编译器后端。</p>

<p>编译命令地址</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre># Objective-C
/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang
# Swift
/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Xcode 编译过程：</p>

<p><img src="/img/p-ios-hikari/15403733934272.jpg" alt="-w1132" /></p>

<h3 id="42-编译器">4.2 编译器</h3>

<h4 id="421-相关名词">4.2.1 相关名词</h4>
<blockquote>
  <p>GCC</p>
</blockquote>

<p>（GNU Compiler Collection）缩写，一个编程语言编译器，是GNU（自由软件理事会）的关键部分。也是GNU工具链的一部分。GCC常被认为是跨平台编译器的事实标准，特别是它的C语言编译器。GCC原本只能处理C语言。但是面对Clang的竞争，很快作出了扩展，现在已经可以处理C++，Fortran、Pascal、Object-C、Java、Ada，以及Go语言。许多操作系统，包括许多Unix系统，如Linux及BSD家族都采用GCC作为标准编译器。MacOSX也是采用这个编译器。</p>

<blockquote>
  <p>LLVM</p>
</blockquote>

<p>是Low Level Virtual Machine的简称。这个库提供了与编译器相关的支持，能够进行程序语言的编译期优化、链接优化、在线编译优化、代码生成。可以作为多种语言编译器的后台来使用。</p>

<blockquote>
  <p>Clang</p>
</blockquote>

<p>Clang 是 LLVM 的子项目，是 C，C++ 和 Objective-C 编译器，目的是提供惊人的快速编译，比 GCC 快3倍，其中的 clang static analyzer 主要是进行语法分析，语义分析和生成中间代码，当然这个过程会对代码进行检查，出错的和需要警告的会标注出来。</p>

<blockquote>
  <p>前端编译器</p>
</blockquote>

<p>编译器前端的任务是进行：语法分析，语义分析，生成中间代码(intermediate representation )。在这个过程中，会进行类型检查，如果发现错误或者警告会标注出来在哪一行。
<img src="/img/p-ios-hikari/15403735367044.jpg" alt="" /></p>

<blockquote>
  <p>后端编译器</p>
</blockquote>

<p>编译器后端会进行机器无关的代码优化，生成机器语言，并且进行机器相关的代码优化。iOS的编译过程，后端的处理如下</p>

<p>LVVM 优化器会进行 BitCode 的生成，链接期优化等等。</p>

<p><img src="/img/p-ios-hikari/15403741982298.jpg" alt="" /></p>

<p>LLVM机器码生成器会针对不同的架构，比如arm64等生成不同的机器码。</p>

<p><img src="/img/p-ios-hikari/15403742042150.jpg" alt="" /></p>

<p>2000年，伊利诺伊大学厄巴纳－香槟分校（University of Illinois at Urbana-Champaign 简称UIUC）这所享有世界声望的一流公立研究型大学的 <strong>Chris Lattner</strong>（他的 twitter <a href="https://twitter.com/clattner_llvm">@clattner_llvm</a> ） 开发了一个叫作 Low Level Virtual Machine 的编译器开发工具套件，后来涉及范围越来越大，可以用于常规编译器，JIT编译器，汇编器，调试器，静态分析工具等一系列跟编程语言相关的工作，于是就把简称 LLVM 这个简称作为了正式的名字。Chris Lattner 后来又开发了 Clang，使得 LLVM 直接挑战 GCC 的地位。2012年，LLVM 获得美国计算机学会 ACM 的软件系统大奖，和 UNIX，WWW，TCP/IP，Tex，JAVA 等齐名。</p>

<p>Chris Lattner 生于 1978 年，2005年加入苹果，将苹果使用的 GCC 全面转为 LLVM。2010年开始主导开发 Swift 语言。</p>

<p>iOS 开发中 Objective-C 是 Clang / LLVM 来编译的。</p>

<h3 id="43-hikari">4.3 Hikari</h3>

<p><a href="https://github.com/HikariObfuscator/Hikari">Hikari</a> 是一个基于 <a href="https://github.com/obfuscator-llvm/obfuscator">Obfuscator-LLVM</a> 对 Xcode9的适配。</p>

<p>OLLVM 是瑞士西北应用科技大学安全实验室于2010年6月份发起的一个项目，该项目旨在提供一套开源的针对 LLVM 的代码混淆工具，以增加对逆向工程的难度。目前，OLLVM已经支持LLVM-4.0版本。</p>

<h4 id="431-安装">4.3.1 安装</h4>

<p>下载 github 提供的 pkg 安装文件并双击安装</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>https://github.com/HikariObfuscator/Hikari/releases
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然后重启 Xcode 就能看到已经有 Kikari 编译工具</p>

<p><img src="/img/p-ios-hikari/15403757992100.jpg" alt="-w640" /></p>

<h4 id="432-使用">4.3.2 使用</h4>

<ol>
  <li><code class="highlighter-rouge">Xcode</code> -&gt; <code class="highlighter-rouge">Toolchains</code> -&gt; <code class="highlighter-rouge">Hikari</code> 将混淆工具和项目关联</li>
  <li>将所有与要运行的 target 相关的 target（包括pod进来的库）<code class="highlighter-rouge">Enable Index-While-Building</code> 的值改为 <em>NO</em>。</li>
  <li><code class="highlighter-rouge">Optimization Level</code> 的值设置为 <code class="highlighter-rouge">None[-O0]</code></li>
  <li>在 <code class="highlighter-rouge">Build Settings</code> -&gt; <code class="highlighter-rouge">Other C Flags</code> 中加入混淆标记</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>-mllvm -enable-bcfobf 		启用伪控制流  
-mllvm -enable-cffobf 		启用控制流平坦化
-mllvm -enable-splitobf 	启用基本块分割  
-mllvm -enable-subobf 		启用指令替换  
-mllvm -enable-acdobf 		启用反class-dump  
-mllvm -enable-indibran 	启用基于寄存器的相对跳转，配合其他加固可以彻底破坏IDA/Hopper的伪代码(俗称F5)  
-mllvm -enable-strcry 		启用字符串加密  
-mllvm -enable-funcwra 		启用函数封装
-mllvm -enable-allob        依次性启用上述所有标记
</pre></td></tr></tbody></table></code></pre></div></div>

<p>重新编译就会使用 Hikari 在编译器后端对项目进行编译了。</p>

<p>将编译后的二进制文件拖入 hopper 中进行对比</p>

<p><img src="/img/p-ios-hikari/15403763613907.jpg" alt="-w1194" /></p>

<p>发现代码已经被混淆过了。
<strong>最新的 Xcode10 通过非官方默认的 Toolchains 编译后的的 ipa 是拒绝提交审核的。</strong></p>

<h2 id="总结">总结</h2>

<p>以上是对 iOS 下马甲包，代码混淆，编译混淆的一些学习实践，实际使用中需要根据自己的实际需求进行调整尝试。</p>

<p>demo 地址：<a href="https://github.com/huanglins/iOSObfuscator">iOSObfuscator</a></p>

<p>加密与破解，编译与反编译永远都是在不停攻防的。没有一堵绝对安全的墙，也没有绝对完美的银弹。只有在开发成本与安全成本中找个一个平衡，才是可持续发展的选择。</p>

<h1 id="参考文章">参考文章</h1>
<ul>
  <li>
    <p>马甲包</p>

    <p><a href="https://www.jianshu.com/p/339c62db048f">马甲包</a></p>

    <p><a href="https://github.com/klaus01/KLGenerateSpamCode">KLGenerateSpamCode</a></p>
  </li>
  <li>
    <p>逆向基础，为什么要混淆</p>

    <p><a href="http://www.cocoachina.com/mac/20150122/10988.html">了解iOS上的可执行文件和Mach-O格式</a></p>
  </li>
  <li>
    <p>类名/方法混淆</p>

    <p><a href="https://blog.csdn.net/yiyaaixuexi/article/details/29201699">iOS安全攻防（二十三）：Objective-C代码混淆</a></p>

    <p><a href="https://www.jianshu.com/p/19bf42f22473">iOS代码混淆</a></p>
  </li>
  <li>
    <p>编译混淆</p>

    <p><a href="https://github.com/ming1016/study/wiki/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-iOS-%E7%BC%96%E8%AF%91-Clang---LLVM">深入剖析 iOS 编译 Clang LLVM</a></p>

    <p><a href="https://juejin.im/post/5ba05c3c6fb9a05d31550275">iOS混淆笔记</a></p>

    <p><a href="https://mp.weixin.qq.com/s?__biz=MzUxMzcxMzE5Ng==&amp;mid=2247488360&amp;idx=1&amp;sn=94fba30a87d0f9bc0b9ff94d3fed3386&amp;source=41#wechat_redirect">基于clang插件的一种iOS包大小瘦身方案</a></p>

    <p><a href="https://juejin.im/post/5ba05c3c6fb9a05d31550275">iOS混淆笔记</a></p>

    <p><a href="https://www.jianshu.com/p/a631b5584de6">Obfuscator-LLVM在iOS中的实践</a></p>
  </li>
  <li>
    <p>审核</p>

    <p><a href="https://juejin.im/post/5bbaba595188255c9f06cdfd?utm_source=gold_browser_extension">一篇文章讲清如何应对 App Store 审核 2.1 大礼包</a></p>
  </li>
</ul>

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/08/25/justice-and-freedom/" data-toggle="tooltip" data-placement="top" title="正义和自由">
                        Previous<br>
                        <span>正义和自由</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/10/30/mysql-slave/" data-toggle="tooltip" data-placement="top" title="Mysql 主从备份和读写分离实践">
                        Next<br>
                        <span>Mysql 主从备份和读写分离实践</span>
                        </a>
                    </li>
                    
                </ul>

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        </a>
        
        
                <a data-sort="0016" 
                    href="/archive/?tag=%E6%8A%8A%E9%85%92%E6%85%B0%E9%A3%8E%E5%B0%98"
                    title="把酒慰风尘"
                    rel="2">把酒慰风尘</a>
        
                <a data-sort="0013" 
                    href="/archive/?tag=iOS"
                    title="iOS"
                    rel="5">iOS</a>
        
                <a data-sort="0015" 
                    href="/archive/?tag=Web%E6%9C%8D%E5%8A%A1%E5%99%A8"
                    title="Web服务器"
                    rel="3">Web服务器</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=%E6%97%85%E8%A1%8C"
                    title="旅行"
                    rel="2">旅行</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B"
                    title="逆向工程"
                    rel="2">逆向工程</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=CentOS"
                    title="CentOS"
                    rel="2">CentOS</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=MySQL"
                    title="MySQL"
                    rel="2">MySQL</a>
        
                <a data-sort="0016" 
                    href="/archive/?tag=Python"
                    title="Python"
                    rel="2">Python
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://shop130631028.taobao.com/">在回忆中 - 卖点小东西</a></li>
  
  <li><a href="https://unsplash.com">unsplash - 好看的图片</a></li>
  
  <li><a href="https://api.vincents.cn/udid">获取UDID</a></li>
  
  <li><a href="https://www.vincents.cn/saylove/">say - vincents.cn</a></li>
  
  <li><a href="https://wechat.vincents.cn">wechat.vincents.cn</a></li>
  
  <li><a href="https://api.vincents.cn/manager">api.vincents.cn</a></li>
  
  <li><a href="http://git.vincents.cn">git.vincents.cn</a></li>
  
  <li><a href="http://idea.vincents.cn">idea.vincents.cn</a></li>
  
  <li><a href="http://rap.vincents.cn">rap.vincents.cn</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- 动态几何线条背景 -->
<!-- <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script> -->


<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "vincents-cn";
    var disqus_identifier = "/2018/10/24/ios-hikari";
    var disqus_url = "http://localhost:4000/2018/10/24/ios-hikari/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->





<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/vincent_darnel">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/huang-lin-70-49">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="http://weibo.com/linxiaomu1995">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://github.com/huanglins">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    渝ICP备17003502号 | Copyright &copy; Vincent 2018
                    <br>
                    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span id="busuanzi_container_site_pv">
                        总访问量<span id="busuanzi_value_site_pv"></span>次
                    </span>
                    <span id="busuanzi_container_site_uv">
                        访客数<span id="busuanzi_value_site_uv"></span>人次
                      </span>
                    <!-- <span id="busuanzi_container_site_pv"> 您是本站第<span id="busuanzi_value_site_pv"></span>位访问者</span>  |  -->
                    <!-- umeng 站长统计 -->
<!--                     <script src="https://s22.cnzz.com/z_stat.php?id=1263843451&web_id=1263843451" language="JavaScript"></script> |  -->
                    | Theme by <a target="_blank" href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/ 
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers   
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->




<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'vincents.cn';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'df0ae995d64933728fd782f538ecf05d';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



</body>

</html>
